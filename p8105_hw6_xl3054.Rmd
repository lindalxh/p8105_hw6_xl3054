---
title: "p8105_hw6_xl3054"
author: "Xinhui Lin (xl3054)"
date: "2025-12-03"
output: github_document
---

# Problem 1
```{r}
library(tidyverse)
homicide = read_csv("data/homicide-data.csv") %>% 
  janitor::clean_names() %>%
  mutate(city_state = paste0(city, ", ", state),
         solved_bin = ifelse(disposition == "Closed by arrest", 1, 0),
         victim_age = ifelse(victim_age %in% c("Unknown", ""), NA, victim_age),
         victim_age = as.numeric(victim_age),
         victim_sex  = factor(victim_sex, levels = c("Female", "Male")),
         victim_race = factor(victim_race)) %>% 
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")),
         victim_race %in% c("White", "Black"))

homicide %>% 
  glm(solved_bin ~ victim_age + victim_sex + victim_race, 
      data = . , family = binomial) %>% 
  broom::tidy(conf.int = TRUE, exponentiate = TRUE) %>% 
  filter(term == "victim_sexMale") %>% 
  select(term, estimate, conf.low, conf.high) %>% 
  knitr::kable(digits = 4)

## for each city
homicide_or = homicide %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(model = purrr::map(data, 
                            ~ glm(solved_bin ~ victim_age + victim_sex + victim_race,
                                  data   = .x,
                                  family = binomial)),
         tidied = purrr::map(model, ~ broom::tidy(.x, conf.int = TRUE, exponentiate = TRUE))) %>% 
  unnest(tidied) %>% 
  filter(term == "victim_sexMale") %>% 
  select(city_state, term, estimate, conf.low,conf.high) %>% 
  arrange(desc(estimate))

homicide_or %>% 
  knitr::kable(digits = 4)

homicide_or %>% 
  ggplot(aes(x = reorder(city_state, estimate), y = estimate)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "red") +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
  coord_flip() +
  labs(x = "City", y = "Adjusted odds ratio (male vs female)",
       title = "Adjusted OR for solving homicides (Male vs Female)") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 7))
```


# Problem 2
```{r}
library(p8105.datasets)
data("weather_df")

set.seed(123)

boot_once = function(data) {
  boot_df = data %>% 
    sample_frac(size = 1, replace = TRUE)
    fit = lm(tmax ~ tmin + prcp, data = boot_df)
    r2_hat = broom::glance(fit)$r.squared
    coef_df = broom::tidy(fit)
    beta1 = coef_df$estimate[coef_df$term == "tmin"]
    beta2 = coef_df$estimate[coef_df$term == "prcp"]
    ratio = beta1 / beta2
    tibble(r2 = r2_hat, ratio = ratio)
}

boot_res = map_dfr(1:5000, ~boot_once(weather_df))

boot_res %>%
  pivot_longer(everything()) %>%
  ggplot(aes(value)) +
  geom_density() +
  facet_wrap(~name, scales = "free") +
  labs(title = "Bootstrap distributions of r^2 and Beta1/Beta2")
```

The bootstrap distribution of $\hat{r^2}$ is kind of tight and almost symmetric, centered around 0.942. This means that the fitted model consistently explains a large amount of the variation in `tmax`, and the estimated $\hat{r^2}$ does not change much across different bootstrap samples.

The ratio $\frac{\hat{\beta_1}}{\hat{\beta_2}}$ compares the effect of minimum temperature relative to the effect of precipitation. However, because the precipitation coefficient is very small and close to zero, this ratio becomes very unstable. As a result, the bootstrap distribution is wide, heavily skewed, and has a long tail toward large negative values. This makes the ratio hard to interpret and less reliable than the estimate of $\hat{r^2}$.

```{r}
ci_r2 = quantile(boot_res$r2, probs = c(0.025, 0.975))
ci_ratio = quantile(boot_res$ratio, probs = c(0.025, 0.975))

tibble(parameter = c("r^2", "beta1 / beta2"),
       lower = c(ci_r2[1], ci_ratio[1]),
       upper = c(ci_r2[2], ci_ratio[2])) %>% 
  knitr::kable(digits = 4, caption = "95% Bootstrap Confidence Intervals")
```

# Problem 3
```{r}
birthweight = read_csv("data/birthweight.csv") %>% 
  janitor::clean_names() %>% 
  mutate(babysex = factor(babysex, levels = c(1, 2),
                          labels = c("male", "female")),
         frace = factor(frace, levels = c(1, 2, 3, 4, 8, 9),
                        labels = c("White", "Black", "Asian", 
                                   "Puerto Rican", "Other", "Unknown")),
         mrace = factor(mrace, levels = c(1, 2, 3, 4, 8),
                        labels = c("White", "Black", "Asian", "Puerto Rican", "Other")),
         malform = factor(malform, levels = c(0, 1), 
                          labels = c("absent", "present")))

birthweight %>% summarize(across(everything(), ~ sum(is.na(.))))

bw_model = lm(bwt ~ babysex + bhead + blength + gaweeks + wtgain + mheight + momage + mrace + ppbmi, data = birthweight)
summary(bw_model)
```

I proposed a regression model that includes the predictors `babysex`, `bhead`, `blength`, `gaweeks`, `wtgain`, `mheight`, `momage`, `mrace`, and `ppbmi`. This model incorporates both infant characteristics and maternal factors that are biologically relevant to birthweight. Babyâ€™s head circumference, height, gestational age, and sex are the primary and most direct indicators of a baby's size and development at birth. The height, weight gain, and BMI of the mother reflect nutritional status and overall growth environment for the baby, which may also influence the baby's birthweight. In addition, I also added the mother's age and race in the model to capture any potential demographic differences that could have an effect on birth outcomes.

```{r}
library(modelr)
birthweight %>% 
  add_predictions(bw_model) %>%
  add_residuals(bw_model) %>% 
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(x = "Fitted birthweight (grams)", y = "Residuals",
       title = "Residuals vs fitted values") +
  theme_minimal()
```

```{r}
# Cross validation
set.seed(123)

cv_df = crossv_mc(birthweight, n = 100, test = 0.2) %>%
  mutate(train = map(train, as_tibble),
         test  = map(test,  as_tibble))

cv_models = cv_df %>% 
  mutate(model_prop = map(train, 
                        ~ lm(bwt ~ babysex + bhead + blength + gaweeks + 
                               wtgain + mheight + momage + mrace + ppbmi,
                             data = .x)),
         model_main = map(train, ~ lm(bwt ~ blength + gaweeks, data = .x)),
         model_int = map(train, ~ lm(bwt ~ bhead * blength * babysex, data = .x)))

rmse_calc = function(model, test_df) {
  preds = predict(model, newdata = test_df)
  sqrt(mean((test_df$bwt - preds)^2))
}

cv_results = cv_models %>%
  mutate(rmse_new   = map2_dbl(model_prop,   test, rmse_calc),
         rmse_main  = map2_dbl(model_main,  test, rmse_calc),
         rmse_int  = map2_dbl(model_int,  test, rmse_calc))

cv_results %>%
  summarize(mean_rmse_new  = mean(rmse_new),
            mean_rmse_main = mean(rmse_main),
            mean_rmse_int = mean(rmse_int))
```






